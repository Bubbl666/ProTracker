<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pro Tracker 1.0</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <h1 class="title">Pro Tracker <span>1.0</span></h1>

    <div class="controls">
      <label class="label">玩家（多个用逗号分隔）：</label>
      <textarea id="players" placeholder="例如：donk666, niko" rows="2"></textarea>

      <div class="row">
        <button id="refreshBtn">刷新数据</button>
        <div class="limit">
          <label>每人条数：</label>
          <select id="limit">
            <option>5</option>
            <option selected>10</option>
            <option>15</option>
          </select>
        </div>
      </div>
      <div id="hint" class="hint"></div>
    </div>

    <div id="result"></div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const resultEl = $("#result");
    const hintEl = $("#hint");
    const refreshBtn = $("#refreshBtn");

    // —— 辅助：从 stats 中取数（字符串或数字都能处理）
    function getNum(obj, key, def = 0) {
      if (!obj || typeof obj !== "object") return def;
      let v = obj[key];
      if (v === undefined || v === null || v === "") return def;
      if (typeof v === "number") return v;
      // 去掉可能存在的百分号
      if (typeof v === "string") {
        v = v.replace("%", "").trim();
        const n = Number(v);
        return Number.isFinite(n) ? n : def;
      }
      return def;
    }

    // —— 近似 HLTV 2.0 计算（不依赖额外字段，基于 KPR / Survival / ADR）
    function computeHLTV2Approx(stats) {
      const kpr = getNum(stats, "K/R Ratio", 0);     // kills per round
      const kills = getNum(stats, "Kills", 0);
      const deaths = getNum(stats, "Deaths", 0);
      const adr = getNum(stats, "ADR", 0);

      // 由 KPR ≈ Kills/Rounds 推回合数
      const rounds = (kpr > 0) ? (kills / kpr) : (kills + deaths) || 1;
      const survival = Math.max(0, Math.min(1, (rounds - deaths) / rounds));

      // HLTV 2.0 的思想：标准化后取平均（简化近似）
      const rating =
        ( (kpr / 0.679) + (survival / 0.317) + (adr / 85.0) ) / 3.0;

      return Number(rating.toFixed(2));
    }

    // —— 生成 Faceit 链接
    const faceitProfileUrl = (nickname) =>
      `https://www.faceit.com/en/players/${encodeURIComponent(nickname)}`;
    const faceitMatchUrl = (matchId) =>
      `https://www.faceit.com/en/cs2/room/${encodeURIComponent(matchId)}`;

    // —— 把 score 用绿色(赢)/红色(输)展示
    function scoreBadge(text, isWin) {
      return `<span class="score ${isWin ? "win" : "lose"}">${text}</span>`;
    }

    // —— 渲染 1 场比赛
    function renderMatchCard(playerNick, match, playerStats) {
      // 1) 标题行：Match 链接 + 地图 + 比分（绿色/红色）
      const matchId = match.match_id;
      const mapName = match.map ?? "-";
      // 从返回结构里取赢输：优先用 player.stats.Result（你的示例里就是这个）
      const resultFlag = getNum(playerStats, "Result", 0); // 1=win, 0=lose
      const isWin = resultFlag === 1;

      // 比分 label：示例数据有两种：字符串 "13 / 10"，或者对象 {faction1:1,faction2:0}
      let scoreLabel = "- : -";
      if (typeof match.score === "string") {
        scoreLabel = match.score;
      } else if (match.score && (match.score.faction1 !== undefined)) {
        scoreLabel = `${match.score.faction1} / ${match.score.faction2}`;
      }

      const title = `
        <div class="match-title">
          <div class="left">
            <a class="match-link" href="${faceitMatchUrl(matchId)}" target="_blank" rel="noopener">
              Match: ${matchId}
            </a>
            <span class="sep">|</span>
            <span>Map: <b>${mapName}</b></span>
            <span class="sep">|</span>
            ${scoreBadge(`Score: ${scoreLabel}`, isWin)}
          </div>
          <div class="right">
            <a class="demo-btn" href="${faceitMatchUrl(matchId)}" target="_blank" rel="noopener" title="打开 Faceit 比赛页下载 DEMO">
              DEMO
            </a>
          </div>
        </div>
      `;

      // 2) 主要统计 + 近似 HLTV 2.0
      const kills = getNum(playerStats, "Kills");
      const deaths = getNum(playerStats, "Deaths");
      const assists = getNum(playerStats, "Assists");
      const adr = getNum(playerStats, "ADR");
      const hs = getNum(playerStats, "Headshots %");
      const kd = getNum(playerStats, "K/D Ratio");
      const kr = getNum(playerStats, "K/R Ratio");
      const rating = computeHLTV2Approx(playerStats);

      const stats = `
        <div class="stats">
          <div class="stat"><span>Kills:</span> <b>${kills}</b></div>
          <div class="stat"><span>Deaths:</span> <b>${deaths}</b></div>
          <div class="stat"><span>Assists:</span> <b>${assists}</b></div>
          <div class="stat"><span>ADR:</span> <b>${adr}</b></div>
          <div class="stat"><span>HS%:</span> <b>${hs}%</b></div>
          <div class="stat"><span>K/D:</span> <b>${kd}</b></div>
          <div class="stat"><span>K/R:</span> <b>${kr}</b></div>
          <div class="stat rating"><span>Rating(≈HLTV2.0):</span> <b>${rating}</b></div>
        </div>
      `;

      return `<div class="card">${title}${stats}</div>`;
    }

    // —— 渲染单个玩家的区块
    function renderPlayerBlock(playerInfo, matches) {
      const nickname = playerInfo.nickname;
      const profile = faceitProfileUrl(nickname);

      let html = `
        <div class="player">
          <div class="player-header">
            <a class="player-name" href="${profile}" target="_blank" rel="noopener">${nickname}</a>
            <span class="player-sub">Faceit Profile</span>
          </div>
      `;

      if (!Array.isArray(matches) || matches.length === 0) {
        html += `<div class="empty">最近 0 场。</div></div>`;
        return html;
      }

      for (const m of matches) {
        const pstats = (m.player && m.player.stats) ? m.player.stats : (m.player?.raw || {});
        html += renderMatchCard(nickname, m, pstats || {});
      }

      html += `</div>`;
      return html;
    }

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return await res.json();
    }

    async function load() {
      resultEl.innerHTML = "";
      hintEl.textContent = "查询中…";

      const raw = $("#players").value.trim();
      const limit = Number($("#limit").value) || 5;
      if (!raw) {
        hintEl.textContent = "请输入玩家名（可多位，用逗号分隔）";
        return;
      }

      const names = raw.split(",").map(s => s.trim()).filter(Boolean);
      const blocks = [];
      let okCount = 0;

      for (const name of names) {
        try {
          // 先取 player_id
          const p = await fetchJSON(`/player?name=${encodeURIComponent(name)}`);
          if (!p || !p.found) {
            blocks.push(`
              <div class="player">
                <div class="player-header">
                  <span class="player-name">${name}</span>
                </div>
                <div class="empty">未找到该玩家。</div>
              </div>
            `);
            continue;
          }

          // 再取比赛
          const ms = await fetchJSON(`/matches/with_stats?player_id=${encodeURIComponent(p.player_id)}&limit=${limit}`);
          blocks.push(renderPlayerBlock({ nickname: p.nickname }, ms || []));
          okCount++;
        } catch (e) {
          blocks.push(`
            <div class="player">
              <div class="player-header">
                <span class="player-name">${name}</span>
              </div>
              <div class="empty">拉取失败：${String(e.message || e)}</div>
            </div>
          `);
        }
      }

      resultEl.innerHTML = blocks.join("");
      hintEl.textContent = `完成，共 ${names.length} 位玩家。`;
    }

    refreshBtn.addEventListener("click", load);

    // 默认填一个例子，方便你演示
    document.addEventListener("DOMContentLoaded", () => {
      const urlPlayers = new URLSearchParams(location.search).get("players");
      if (urlPlayers) {
        $("#players").value = urlPlayers;
      } else {
        $("#players").value = "donk666";
      }
      load();
    });
  </script>
</body>
</html>
