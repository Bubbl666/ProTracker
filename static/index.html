<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Faceit 最近比赛查看器</title>
    <style>
      body { background:#0b0f14; color:#d8e1e8; font-family: ui-sans-serif,system-ui; }
      .wrap { max-width: 900px; margin: 32px auto; padding: 0 16px; }
      h1 { color:#7CFC8A; margin: 0 0 16px; }
      .row { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
      input, select, button {
        background:#0f1620; color:#d8e1e8; border:1px solid #243140; border-radius:8px;
        padding:10px 12px; outline:none;
      }
      button { cursor:pointer; }
      .card {
        background:#0f1620; border:1px solid #243140; border-radius:12px; padding:14px 16px; margin:14px 0;
      }
      .muted { color:#9fb0bf; font-size:13px; }
      .kvs { display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }
      .tag { background:#132133; padding:4px 8px; border-radius:6px; font-size:12px; }
      a { color:#8dd3ff; text-decoration: none; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Faceit 最近比赛查看器</h1>

      <div class="row">
        <label>玩家（昵称或id）：</label>
        <input id="q" value="donk666" />
        <label>每人条数：</label>
        <select id="cnt">
          <option>5</option><option>10</option><option>15</option>
        </select>
        <button id="btn">刷新数据</button>
      </div>

      <div id="log" class="muted">准备就绪。</div>
      <div id="out"></div>
    </div>

    <script>
      const api = (path) => path; // 同域部署

      const log = (t) => (document.getElementById("log").textContent = t);

      async function getPlayer(query) {
        const r = await fetch(api(`/players?query=${encodeURIComponent(query)}`));
        return r.json();
      }

      async function getMatchesWithStats(player_id, limit) {
        // 后端同时支持 ?limit= 与 ?size=
        const r = await fetch(api(`/matches/with_stats?player_id=${player_id}&limit=${limit}`));
        return r.json();
      }

      function kv(key, val) {
        return `<span class="tag"><b>${key}：</b>${val}</span>`;
      }

      function render(data, player) {
        const o = document.getElementById("out");
        o.innerHTML = "";
        const head = document.createElement("div");
        head.className = "card";
        head.innerHTML =
          `<div style="font-weight:700;font-size:18px">${player.nickname}</div>` +
          `<div class="muted">player_id=${player.player_id}</div>`;
        o.appendChild(head);

        data.forEach((m) => {
          const div = document.createElement("div");
          div.className = "card";
          const map = m.map || "-";
          const score = (typeof m.score === "string")
            ? m.score
            : (m.score && (m.score.faction1 !== undefined || m.score.faction2 !== undefined))
              ? `${m.score.faction1 ?? "-"} / ${m.score.faction2 ?? "-"}`
              : "-";

          let statsBlock = `<div class="muted">(该场没有拉到你的统计)</div>`;
          if (m.player && (m.player.kills !== undefined)) {
            const p = m.player;
            statsBlock =
              `<div class="kvs">` +
              kv("Kills", p.kills) +
              kv("Deaths", p.deaths) +
              kv("Assists", p.assists) +
              kv("ADR", p.adr) +
              kv("HS%", p.hs) +
              kv("K/D", p.kd) +
              kv("K/R", p.kr) +
              `</div>`;
          }

          div.innerHTML =
            `<div><b>Match:</b> ${m.match_id} | <b>Map:</b> ${map} | <b>Score:</b> ${score}</div>` +
            `<div style="margin-top:6px"><b>Stats:</b> ${statsBlock}</div>`;
          o.appendChild(div);
        });
      }

      async function run() {
        const q = document.getElementById("q").value.trim();
        const limit = parseInt(document.getElementById("cnt").value, 10) || 5;
        log("查询玩家中…");
        const p = await getPlayer(q);
        if (!p || !p.found) {
          log("未找到该玩家。");
          return;
        }
        log(`获取最近 ${limit} 场比赛…`);
        const data = await getMatchesWithStats(p.player_id, limit);
        render(data, p);
        log("完成。");
      }

      document.getElementById("btn").addEventListener("click", run);
      // 默认自动跑一次
      run();
    </script>
  </body>
</html>
