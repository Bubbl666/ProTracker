<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro Tracker 1.0</title>
  <style>
    :root{
      --bg:#0f141a;
      --panel:#0b1117;
      --muted:#8aa1b2;
      --text:#d5e3f0;
      --green:#28c57a;
      --red:#ff4d4f;
      --blue:#4da3ff;
      --chip:#17212b;
      --chip2:#0f1b24;
      --border:#1e2934;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px;
      background:var(--bg); color:var(--text);
      font:14px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Noto Sans CJK, "Helvetica Neue", Arial;
    }
    h1{margin:0 0 16px;font-weight:800;letter-spacing:.2px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .input{
      flex:1 1 520px;
      display:flex; align-items:center; gap:8px;
      background:#0a1016; border:1px solid var(--border);
      border-radius:10px; padding:10px 12px;
    }
    .input input{
      flex:1; background:transparent; border:none; color:var(--text);
      outline:none; font-size:14px;
    }
    select, button{
      background:#101721; border:1px solid var(--border); color:var(--text);
      padding:8px 10px; border-radius:10px; font-size:14px; cursor:pointer;
    }
    button:hover, select:hover{filter:brightness(1.05)}
    .hint{margin:10px 0 14px; color:var(--muted); font-size:12px}

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap:14px;
    }
    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden;
    }
    .card .hd{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px; background:#0a1016; border-bottom:1px solid var(--border);
    }
    .card .hd .name{font-weight:800; letter-spacing:.2px}
    .card .hd a{color:var(--blue); text-decoration:none}
    table{
      width:100%; border-collapse:collapse; table-layout:fixed;
    }
    thead th{
      position:sticky; top:0; z-index:1;
      background:#0e1620; font-weight:600; color:var(--muted);
      padding:8px; border-bottom:1px solid var(--border);
      font-size:12px;
    }
    tbody td{
      padding:9px 8px; border-bottom:1px solid var(--border); font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    tbody tr:hover{background:#0e1822}
    .mono{font-variant-numeric:tabular-nums}
    .pill{padding:2px 8px; border-radius:999px; background:var(--chip); display:inline-block}
    .score.win{color:var(--green); font-weight:700}
    .score.loss{color:var(--red); font-weight:700}
    .muted{color:var(--muted)}
    .link{color:var(--blue); text-decoration:none}
    .nowrap{white-space:nowrap}
    .center{text-align:center}
    .right{text-align:right}
  </style>
</head>
<body>
  <h1>Pro Tracker 1.0</h1>

  <div class="row">
    <div class="input">
      <input id="players" placeholder="donk666, niko, s1s1（逗号分隔多个）" />
    </div>
    <select id="limit">
      <option value="5">每人 5 场</option>
      <option value="10">每人 10 场</option>
    </select>
    <button id="refresh">刷新数据</button>
  </div>

  <div class="hint">提示：Match 可点击 Faceit 比赛页下载 Demo；比分按胜负上色；时间为选手的本地时间。</div>

  <div id="grid" class="grid"></div>

  <script>
    const $ = (sel)=>document.querySelector(sel);
    const grid = $("#grid");
    const inpPlayers = $("#players");
    const selLimit = $("#limit");
    const btnRefresh = $("#refresh");

    // 默认示例
    inpPlayers.value = "donk666, niko, s1s1";

    btnRefresh.addEventListener("click", loadAll);
    window.addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadAll(); });

    async function fetchPlayer(name, limit){
      const url = `/player?name=${encodeURIComponent(name)}&limit=${limit}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("fetch failed");
      return res.json();
    }

    function playerCard(data){
      const name = data.player;
      const profile = data.profile_url || "#";
      const rows = Array.isArray(data.matches) ? data.matches : [];

      const col = document.createElement("div");
      col.className = "card";

      // 头部
      const hd = document.createElement("div");
      hd.className = "hd";
      hd.innerHTML = `
        <div class="name">${name}</div>
        <a class="link" href="${profile}" target="_blank" rel="noopener">Faceit</a>
      `;
      col.appendChild(hd);

      // 表格
      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:135px">Date</th>
            <th>Match</th>
            <th class="center" style="width:64px">Result</th>
            <th class="center" style="width:72px">Score</th>
            <th class="center" style="width:68px">K</th>
            <th class="center" style="width:68px">A</th>
            <th class="center" style="width:68px">D</th>
            <th class="center" style="width:72px">K/D</th>
            <th class="center" style="width:72px">ADR</th>
            <th class="center" style="width:66px">HS%</th>
            <th class="center" style="width:90px">Map</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      if(rows.length===0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="11" class="muted center">最近 0 场。</td>`;
        tbody.appendChild(tr);
      }else{
        rows.forEach(r=>{
          const scoreClass = r.win ? "win" : "loss";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono">${r.date || ""}</td>
            <td class="nowrap">
              <a class="link" href="${r.match_url}" target="_blank" rel="noopener">
                ${r.match_id?.slice(0,4)}…${r.match_id?.slice(-4)}
              </a>
            </td>
            <td class="center">${r.result || "-"}</td>
            <td class="center score ${scoreClass}">${r.score || "-"}</td>
            <td class="center mono">${r.k ?? 0}</td>
            <td class="center mono">${r.a ?? 0}</td>
            <td class="center mono">${r.d ?? 0}</td>
            <td class="center mono">${r.kd ?? 0}</td>
            <td class="center mono">${r.adr ?? 0}</td>
            <td class="center mono">${r.hs ?? 0}</td>
            <td class="center mono">${r.map || "-"}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      col.appendChild(table);
      return col;
    }

    async function loadAll(){
      const names = inpPlayers.value
        .split(",")
        .map(s=>s.trim())
        .filter(Boolean);

      const limit = parseInt(selLimit.value,10) || 5;

      grid.innerHTML = ""; // 清空（避免重复一行）
      if(names.length===0){
        grid.innerHTML = `<div class="muted">请输入至少一个玩家昵称。</div>`;
        return;
      }

      const tasks = names.map(n=>fetchPlayer(n, limit).catch(()=>({player:n, profile_url:"#", matches:[]})));
      const all = await Promise.all(tasks);
      all.forEach(data => grid.appendChild(playerCard(data)));
    }

    // 首次自动加载
    loadAll();
  </script>
</body>
</html>
