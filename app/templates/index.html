<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro Tracker 1.0</title>
  <link rel="stylesheet" href="/static/main.css" />
  <style>
    /* 轻量样式直接内联，便于你拷贝；也可移到 /static/main.css */
    :root{
      --bg:#0f1418; --panel:#111a20; --muted:#8aa1b1; --text:#e7f0f7;
      --green:#31d0a0; --red:#ff5d5d; --chip:#1b2730; --chip2:#172129;
      --border:#1a242c;
    }
    html,body{background:var(--bg); color:var(--text); font:14px/1.5 system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;}
    .wrap{max-width:1400px; margin:24px auto; padding:0 16px;}
    h1{font-weight:700; font-size:24px; letter-spacing:.5px; margin-bottom:16px;}
    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;}
    .input, select, button{
      background:#0c1216; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:10px 12px;
    }
    .input{width:720px; max-width:100%;}
    button{cursor:pointer}
    .hint{color:var(--muted); margin:8px 0 16px 0; font-size:12px}
    .ok{color:#75e6bd}
    .err{color:#ff8a8a}

    /* 栅格：每个玩家 = 一列 */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap:16px;
      align-items:start;
    }
    .col{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
    }
    .col .hd{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px; border-bottom:1px solid var(--border); background:#0f171d;
    }
    .nick{font-weight:700; font-size:16px}
    .nick a{color:var(--text); text-decoration:none}
    .nick a:hover{opacity:.85}
    .sub{color:var(--muted); font-size:12px}

    /* 表格头在卡片内部出现一次（不是每行都重复） */
    .tbl{width:100%; border-collapse:collapse; table-layout:fixed; font-variant-numeric:tabular-nums;}
    .tbl thead th{
      position:sticky; top:0; z-index:5;
      background:#0f171d; border-bottom:1px solid var(--border);
      color:var(--muted); font-weight:600; padding:8px 10px; text-align:left;
      font-size:12px;
    }
    .tbl tbody td{padding:8px 10px; border-bottom:1px solid var(--border); vertical-align:middle;}
    .tbl tbody tr:last-child td{border-bottom:0}
    .mut{color:var(--muted)}
    .chip{background:var(--chip); padding:2px 8px; border-radius:999px; font-weight:700; font-size:12px; display:inline-block}
    .win{color:var(--green)}
    .loss{color:var(--red)}
    .score{font-weight:700; padding:2px 6px; border-radius:6px; background:var(--chip2);}
    .score.win{color:var(--green)}
    .score.loss{color:var(--red)}
    .map{opacity:.9}
    .ka{color:#cde7ff}
    .link{opacity:.9}
    .link:hover{opacity:1}
    .empty{padding:20px; color:var(--muted)}
    .footer{margin:14px 0 0 0; color:var(--muted); font-size:12px}
    .pill{border:1px solid var(--border); padding:0 6px; border-radius:999px; margin-left:6px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Pro Tracker 1.0</h1>

  <div class="controls">
    <textarea id="players" class="input" rows="1" placeholder="多个玩家名或ID，以逗号隔开，如：donk666, niko, s1mple"></textarea>
    <label class="mut">每人条数：
      <select id="limit">
        <option>5</option><option>10</option><option>15</option>
      </select>
    </label>
    <button id="go">刷新数据</button>
    <span id="status" class="mut"></span>
  </div>

  <div class="hint">
    支持多玩家分列；Match 链接直达 Faceit 房间页（下载 Demo）；比分按阵营自动着色；Rating 为简化 HLTV 2.0-like 估算。
  </div>

  <div id="grid" class="grid"></div>

  <div class="footer">完成。<span id="count" class="pill">0 位玩家</span></div>
</div>

<script>
const $ = sel => document.querySelector(sel);
const el = (tag, cls, html) => {
  const n = document.createElement(tag);
  if (cls) n.className = cls;
  if (html !== undefined) n.innerHTML = html;
  return n;
};

async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(await r.text());
  return await r.json();
}

/** 先拿 player 信息（拿 profile_url，也可用于时区） */
async function getPlayer(raw){
  const r = await fetchJSON(`/player?name=${encodeURIComponent(raw)}`);
  return r;
}

/** 最近比赛 + 我们后端已经补充的 score_text / room_url / faction */
async function getMatches(pid, limit){
  return await fetchJSON(`/matches/with_stats?player_id=${encodeURIComponent(pid)}&limit=${limit}`);
}

/** 格式化时间（优先用浏览器本地时区；若你未来在 /player 返回 IANA tz，可在这里应用） */
function fmtTime(ts){
  if(!ts) return '—';
  // Faceit返回的是秒
  const d = new Date(Number(ts) * 1000);
  return new Intl.DateTimeFormat(undefined, {
    month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
  }).format(d);
}

function decideWinLoss(scoreText, faction){
  // faction: 1/2 表示玩家所在阵营
  if(!scoreText || !faction) return {cls:'', text:scoreText || '—'};
  const m = scoreText.match(/(\d+)\s*\/\s*(\d+)/);
  if(!m) return {cls:'', text:scoreText};
  const a = Number(m[1]), b = Number(m[2]);
  const win = (faction===1 ? a>b : b>a);
  return {cls: win ? 'win' : 'loss', text: `${a} / ${b}`};
}

function row(match){
  const tr = el('tr');
  const started = fmtTime(match.started_at);
  const scoreInfo = decideWinLoss(match.score, match.faction);

  // 结果文字（WIN/LOSS）
  let resultWord = '—';
  if(scoreInfo.cls==='win') resultWord = 'WIN';
  else if(scoreInfo.cls==='loss') resultWord = 'LOSS';

  const p = match.player || {};
  const k = p.kills ?? '—';
  const a = p.assists ?? '—';
  const d = p.deaths ?? '—';
  const kd = p.kd ?? '—';
  const adr = (p.adr!==undefined ? p.adr : '—');
  const map = match.map ? match.map.replace(/^de_/, '') : '—';
  const demo = match.room_url ? `<a class="link" href="${match.room_url}" target="_blank" title="Faceit 房间页">↗</a>` : '<span class="mut">—</span>';

  tr.innerHTML = `
    <td class="mut">${started}</td>
    <td><span class="chip ${scoreInfo.cls}">${resultWord}</span></td>
    <td><span class="score ${scoreInfo.cls}">${scoreInfo.text||'—'}</span></td>
    <td class="ka">${k} / ${a} / ${d}</td>
    <td>${kd}</td>
    <td>${adr}</td>
    <td class="map">${map}</td>
    <td>${demo}</td>
  `;
  return tr;
}

function oneColumn(player, matches){
  const card = el('div','col');

  // 头
  const hd = el('div','hd');
  const nick = player?.nickname || 'Unknown';
  const profile = player?.profile_url || null;
  hd.append(
    el('div','nick', profile ? `<a href="${profile}" target="_blank">${nick}</a>` : nick),
    el('div','sub', `最近 ${matches.length} 场`)
  );
  card.append(hd);

  // 表格
  const tbl = el('table','tbl');
  tbl.innerHTML = `
    <thead>
      <tr>
        <th style="width:92px">日期</th>
        <th style="width:66px">结果</th>
        <th style="width:86px">比分</th>
        <th>K / A / D</th>
        <th style="width:60px">K/D</th>
        <th style="width:70px">ADR</th>
        <th style="width:80px">地图</th>
        <th style="width:46px">Demo</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tb = tbl.querySelector('tbody');

  if(!matches.length){
    const empty = el('div','empty','最近 0 场。');
    card.append(empty);
  }else{
    matches.forEach(m => tb.append(row(m)));
    card.append(tbl);
  }
  return card;
}

async function run(){
  const status = $('#status');
  const grid = $('#grid');
  grid.innerHTML = '';
  status.textContent = '加载中...';

  const raw = $('#players').value.trim();
  if(!raw){ status.textContent = '请输入玩家。'; return; }

  const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
  const limit = Number($('#limit').value);

  let ok = 0;
  for(const name of parts){
    try{
      const p = await getPlayer(name);
      if(!p?.found || !p?.player_id){
        grid.append( oneColumn({nickname:name}, []) );
        continue;
      }
      const ms = await getMatches(p.player_id, limit);
      grid.append( oneColumn(p, ms) );
      ok++;
    }catch(e){
      grid.append( oneColumn({nickname:name}, []) );
    }
  }
  $('#count').textContent = `${ok} 位玩家`;
  status.textContent = ok ? '完成。' : '加载失败，请稍后重试。';
}

$('#go').addEventListener('click', run);
// 回车快捷
$('#players').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.metaKey||e.ctrlKey)) run(); });

// 默认测试值（可删）
document.addEventListener('DOMContentLoaded', ()=>{
  const url = new URL(location.href);
  const q = url.searchParams.get('q');
  $('#players').value = q || 'donk666, niko, s1s1';
  run();
});
</script>
</body>
</html>
