<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pro Tracker 1.0</title>
  <style>
    :root{
      --bg:#0f1419; --panel:#121821; --muted:#7d8b99; --fg:#e6f0ff;
      --green:#22c55e; --red:#ef4444; --chip:#1b2430; --chip2:#0d121a;
      --brand:#9ff8c1;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui,Segoe UI,Helvetica,Arial;}
    header{padding:24px 20px 8px;max-width:1200px;margin:auto;}
    h1{margin:0 0 12px;font-size:28px;color:var(--brand)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input,select,button{
      background:#0b1016;border:1px solid #1f2a37;color:var(--fg);
      padding:10px 12px;border-radius:10px;outline:none;
    }
    .input{flex:1;min-width:260px}
    button{cursor:pointer}
    .hint{color:var(--muted);margin-top:6px}

    .grid{max-width:1200px;margin:16px auto 40px;display:grid;gap:12px}
    /* 自适应横向多列（每列最小 320px） */
    .grid{grid-template-columns:repeat(auto-fill,minmax(320px,1fr));}

    .col{background:var(--panel);border:1px solid #1f2a37;border-radius:12px;overflow:hidden}
    .col header{padding:12px 14px;background:#0d121a;border-bottom:1px solid #1f2a37}
    .col header a{color:#9ad8ff;text-decoration:none}
    .col header .meta{color:var(--muted);font-size:12px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #1f2a37;white-space:nowrap}
    th{color:#a9b8c6;text-align:left;font-weight:600}
    td .chip{display:inline-block;background:var(--chip);padding:2px 8px;border-radius:999px;font-size:12px}
    .win{color:var(--green)} .loss{color:var(--red)}
    .score.win{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3)}
    .score.loss{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3)}
    .muted{color:var(--muted)}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
<header>
  <h1>Pro Tracker 1.0</h1>
  <div class="toolbar">
    <input id="players" class="input" placeholder="多个选手用逗号分隔，例如：donk666, niko, s1s1" />
    <select id="limit">
      <option value="5">每人 5 场</option>
      <option value="10">每人 10 场</option>
      <option value="15">每人 15 场</option>
    </select>
    <select id="tz">
      <option value="Asia/Shanghai">Asia/Shanghai（北京时间）</option>
      <option value="Europe/Moscow">Europe/Moscow</option>
      <option value="Europe/Berlin">Europe/Berlin</option>
      <option value="UTC">UTC</option>
      <option value="America/New_York">America/New_York</option>
    </select>
    <button id="go">刷新数据</button>
  </div>
  <div class="hint">提示：Match 可点击 Faceit 比赛页下载 Demo；比分按胜负上色；时间按所选时区显示。</div>
</header>

<main class="grid" id="grid"></main>

<script>
const elPlayers = document.getElementById('players');
const elLimit   = document.getElementById('limit');
const elTZ      = document.getElementById('tz');
const elGo      = document.getElementById('go');
const elGrid    = document.getElementById('grid');

// 默认示例
elPlayers.value = 'donk666, niko, s1s1';

elGo.addEventListener('click', loadAll);
window.addEventListener('load', loadAll);

async function loadAll(){
  const names = elPlayers.value.split(',').map(s => s.trim()).filter(Boolean);
  const limit = elLimit.value;
  const tz    = elTZ.value;
  if(!names.length){ elGrid.innerHTML = ''; return; }

  elGrid.innerHTML = ''; // 清空
  const cards = await Promise.all(names.map(n => loadOne(n, limit, tz)));
  cards.forEach(card => elGrid.appendChild(card));
}

async function loadOne(name, limit, tz){
  const card = document.createElement('section');
  card.className = 'col';
  card.innerHTML = `
    <header>
      <div><a id="p_${css(name)}" href="#" target="_blank">${escapeHTML(name)}</a></div>
      <div class="meta">最近 <span id="c_${css(name)}">0</span> 场</div>
    </header>
    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th class="nowrap">Date</th>
            <th class="nowrap">Match</th>
            <th class="nowrap">Result</th>
            <th class="nowrap">Score</th>
            <th class="nowrap">K/A/D</th>
            <th class="nowrap">K/D</th>
            <th class="nowrap">ADR</th>
            <th class="nowrap">HS%</th>
            <th class="nowrap">Map</th>
          </tr>
        </thead>
        <tbody id="tb_${css(name)}">
          <tr><td colspan="9" class="muted">加载中…</td></tr>
        </tbody>
      </table>
    </div>
  `;

  try{
    const res = await fetch(`/player?name=${encodeURIComponent(name)}&limit=${limit}&tz=${encodeURIComponent(tz)}`);
    const data = await res.json();

    const a = card.querySelector('#p_'+css(name));
    a.href = data.profile_url || '#';

    const tb = card.querySelector('#tb_'+css(name));
    tb.innerHTML = '';
    (data.matches || []).forEach(row => {
      const win = row.result === 'Win';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="nowrap">${escapeHTML(row.date || '')}</td>
        <td class="nowrap"><a href="${row.match_url}" target="_blank">${escapeHTML(shortMatch(row.match_url))}</a></td>
        <td class="nowrap ${win?'win':'loss'}">${row.result}</td>
        <td class="nowrap"><span class="chip score ${win?'win':'loss'}">${escapeHTML(row.score)}</span></td>
        <td class="nowrap">${row.k} / ${row.a} / ${row.d}</td>
        <td>${row.kd}</td>
        <td>${row.adr}</td>
        <td>${row.hs}%</td>
        <td class="nowrap">${escapeHTML(row.map || '-')}</td>
      `;
      tb.appendChild(tr);
    });

    card.querySelector('#c_'+css(name)).textContent = (data.matches || []).length;
  }catch(e){
    const tb = card.querySelector('#tb_'+css(name));
    tb.innerHTML = `<tr><td colspan="9" class="loss">加载失败</td></tr>`;
  }

  return card;
}

function css(s){ return s.replace(/[^a-z0-9_]/ig,'_');}
function escapeHTML(s){ return (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function shortMatch(url){
  // https://www.faceit.com/en/cs2/room/{match_id} -> 只显示 match_id 后 6 位
  const id = (url||'').split('/').pop() || '';
  if(!id) return 'Match';
  return '...' + id.slice(-8);
}
</script>
</body>
</html>
