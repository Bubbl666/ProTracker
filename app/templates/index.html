<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro Tracker 1.0</title>
  <style>
    :root{
      --bg:#0f141a;
      --panel:#0b1117;
      --muted:#8aa1b2;
      --text:#d5e3f0;
      --green:#28c57a;
      --red:#ff4d4f;
      --blue:#4da3ff;
      --border:#1e2934;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px;
      background:var(--bg); color:var(--text);
      font:14px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Noto Sans CJK, "Helvetica Neue", Arial;
    }
    h1{margin:0 0 16px;font-weight:800;letter-spacing:.2px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .input{
      flex:1 1 520px;
      display:flex; align-items:center; gap:8px;
      background:#0a1016; border:1px solid var(--border);
      border-radius:10px; padding:10px 12px;
    }
    .input input{
      flex:1; background:transparent; border:none; color:var(--text);
      outline:none; font-size:14px;
    }
    select, button{
      background:#101721; border:1px solid var(--border); color:var(--text);
      padding:8px 10px; border-radius:10px; font-size:14px; cursor:pointer;
    }
    button:hover, select:hover{filter:brightness(1.05)}
    .hint{margin:10px 0 14px; color:var(--muted); font-size:12px}

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap:14px;
    }
    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden;
    }
    .card .hd{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px; background:#0a1016; border-bottom:1px solid var(--border);
    }
    .card .hd .name{font-weight:800; letter-spacing:.2px}
    .card .hd a{color:var(--blue); text-decoration:none}

    table{width:100%; border-collapse:collapse; table-layout:fixed}
    thead th{
      position:sticky; top:0; z-index:1;
      background:#0e1620; font-weight:600; color:var(--muted);
      padding:8px; border-bottom:1px solid var(--border);
      font-size:12px;
    }
    tbody td{
      padding:9px 8px; border-bottom:1px solid var(--border); font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    tbody tr:hover{background:#0e1822}
    .mono{font-variant-numeric:tabular-nums}
    .score.win a{color:var(--green); font-weight:700; text-decoration:none}
    .score.loss a{color:var(--red); font-weight:700; text-decoration:none}
    .muted{color:var(--muted)}
    .center{text-align:center}
    .link{color:var(--blue); text-decoration:none}
  </style>
</head>
<body>
  <h1>Pro Tracker 1.0</h1>

  <div class="row">
    <div class="input">
      <input id="players" placeholder="donk666, niko, s1s1（逗号分隔多个）" />
    </div>
    <select id="limit">
      <option value="5">每人 5 场</option>
      <option value="10">每人 10 场</option>
    </select>
    <button id="refresh">刷新数据</button>
  </div>

  <div class="hint">提示：Score 为可点击链接（跳转 Faceit 房间页下载 Demo）；比分按胜负上色；时间为选手本地时间。</div>

  <div id="grid" class="grid"></div>

  <script>
    const $ = (sel)=>document.querySelector(sel);
    const grid = $("#grid");
    const inpPlayers = $("#players");
    const selLimit = $("#limit");
    const btnRefresh = $("#refresh");

    // 默认示例
    inpPlayers.value = "donk666, niko, s1s1";

    btnRefresh.addEventListener("click", loadAll);
    window.addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadAll(); });

    async function fetchPlayer(name, limit){
      const url = `/player?name=${encodeURIComponent(name)}&limit=${limit}`;
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error("fetch failed");
      return res.json();
    }

    function playerCard(data){
      const name = data.player;
      const profile = data.profile_url || "#";
      const rows = Array.isArray(data.matches) ? data.matches : [];

      const col = document.createElement("div");
      col.className = "card";

      // header
      const hd = document.createElement("div");
      hd.className = "hd";
      hd.innerHTML = `
        <div class="name">${name}</div>
        <a class="link" href="${profile}" target="_blank" rel="noopener">Faceit</a>
      `;
      col.appendChild(hd);

      // compact table: Date / Result / Score(link) / K
      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:160px">Date</th>
            <th style="width:70px" class="center">Result</th>
            <th style="width:90px" class="center">Score</th>
            <th style="width:55px" class="center">K</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      if(rows.length===0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="muted center">最近 0 场。</td>`;
        tbody.appendChild(tr);
      }else{
        rows.forEach(r=>{
          const scoreClass = r.win ? "win" : "loss";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono">${r.date || ""}</td>
            <td class="center">${r.result || "-"}</td>
            <td class="center score ${scoreClass}">
              <a href="${r.match_url}" target="_blank" rel="noopener">${r.score || "-"}</a>
            </td>
            <td class="center mono">${r.k ?? 0}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      col.appendChild(table);
      return col;
    }

    // 防止并发导致重复渲染：用批次令牌 + replaceChildren
    let lastRun = 0;

    async function loadAll(){
      const names = inpPlayers.value
        .split(",")
        .map(s=>s.trim())
        .filter(Boolean);

      const limit = parseInt(selLimit.value,10) || 5;

      const runId = ++lastRun; // 本次批次号

      // 渲染“加载中”
      grid.replaceChildren();
      const loading = document.createElement("div");
      loading.className = "muted";
      loading.textContent = "加载中…";
      grid.appendChild(loading);

      if(names.length===0){
        loading.textContent = "请输入至少一个玩家昵称。";
        return;
      }

      const tasks = names.map(n=>fetchPlayer(n, limit).catch(()=>({player:n, profile_url:"#", matches:[]})));
      const all = await Promise.all(tasks);

      // 如果已经有更新的批次在跑，丢弃这批结果，避免重复显示
      if(runId !== lastRun) return;

      const columns = all.map(data => playerCard(data));
      grid.replaceChildren(...columns);
    }

    // 首次加载（只跑一次）
    loadAll();
  </script>
</body>
</html>
